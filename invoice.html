<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Delivery Challan</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6fb;
}
.container{
    width:900px;
    margin:auto;
    background:white;
    padding:25px;
}
h2{
    text-align:center;
    letter-spacing:2px;
}
.company{
    text-align:center;
    color:#1e40af;
    font-size:22px;
    font-weight:bold;
}
.top-info{
    width:100%;
    margin-top:20px;
}
.top-info td{
    padding:5px;
}
input{
    border:none;
    border-bottom:1px solid #ccc;
    width:100%;
}
table{
    width:100%;
    border-collapse:collapse;
}
table,th,td{
    border:1px solid #999;
}
th{
    background:#2563eb;
    color:white;
}
.total-section{
    text-align:right;
    font-weight:bold;
}
button{
    background:#2563eb;
    color:white;
    padding:6px 12px;
    border:none;
    margin:5px;
}
.noPrint{
    margin-top:10px;
}
@media print{
    .noPrint{display:none;}
}
</style>
</head>

<body>

<div id="challan" class="container">

<h2>DELIVERY CHALLAN</h2>

<div class="company">
<input id="companyName" placeholder="Company Name">
</div>
<center>
<input id="address" placeholder="Address"><br>
Tel: <input id="phone" placeholder="Phone">
</center>

<br><hr>

<table class="top-info">
<tr>
<td>Challan No:</td>
<td><input id="challanNo"></td>
<td>Buyer's Detail:</td>
<td><input id="buyer"></td>
</tr>
<tr>
<td>Date:</td>
<td><input type="date" id="date"></td>
<td>Buyer's Ph No:</td>
<td><input id="buyerPhone"></td>
</tr>
<tr>
<td>Terms of Delivery:</td>
<td colspan="3"><input id="terms"></td>
</tr>
</table>

<br>

<table id="items">
<tr>
<th>S.N</th>
<th>Description of Goods</th>
<th>Quantity</th>
<th>Size</th>
<th>Rate</th>
<th>Total Amount</th>
<th class="noPrint">Action</th>
</tr>
</table>

<div class="noPrint">
<button onclick="addRow()">Add Row</button>
</div>

<br>

<div class="total-section">
Grand Total: Rs. <span id="grandTotal">0</span>
</div>

<br><br><br>

Receiver's Signature ________  
<span style="float:right;">Authorized Signature ________</span>

</div>

<div class="noPrint" style="text-align:center;">
<button onclick="saveChallan()">Save</button>
<button onclick="printChallan()">Print</button>
<button onclick="saveImage()">Save as Image</button>
</div>

<script>

let editingIndex=null;

function addRow(data=null){
let table=document.getElementById("items");
let row=table.insertRow();
let index=table.rows.length-1;

row.innerHTML=`
<td>${index}</td>
<td><input class="desc" value="${data?data.desc:''}"></td>
<td><input class="qty" value="${data?data.qty:''}"></td>
<td><input value="${data?data.size:''}"></td>
<td><input class="rate" value="${data?data.rate:''}"></td>
<td class="rowTotal">0</td>
<td class="noPrint"><button onclick="removeRow(this)">X</button></td>
`;

calculate();
}

function removeRow(btn){
btn.parentNode.parentNode.remove();
calculate();
}

document.addEventListener("input",calculate);

function calculate(){
let qty=document.querySelectorAll(".qty");
let rate=document.querySelectorAll(".rate");
let total=document.querySelectorAll(".rowTotal");

let grand=0;

for(let i=0;i<qty.length;i++){
let q=parseFloat(qty[i].value)||0;
let r=parseFloat(rate[i].value)||0;
let t=q*r;
total[i].innerText=t;
grand+=t;
}
document.getElementById("grandTotal").innerText=grand;
}

function saveChallan(){
let items=[];
document.querySelectorAll("#items tr").forEach((row,i)=>{
if(i==0)return;
items.push({
desc:row.cells[1].children[0].value,
qty:row.cells[2].children[0].value,
size:row.cells[3].children[0].value,
rate:row.cells[4].children[0].value
});
});

let challan={
company:companyName.value,
address:address.value,
phone:phone.value,
challanNo:challanNo.value,
buyer:buyer.value,
buyerPhone:buyerPhone.value,
date:date.value,
terms:terms.value,
items:items
};

let data=JSON.parse(localStorage.getItem("challans")||"[]");

if(editingIndex!==null){
data[editingIndex]=challan;
editingIndex=null;
}else{
data.push(challan);
}

localStorage.setItem("challans",JSON.stringify(data));
alert("Saved Successfully!");
}

function printChallan(){
window.print();
}

function saveImage(){
html2canvas(document.getElementById("challan")).then(canvas=>{
let link=document.createElement("a");
link.download="delivery_challan.png";
link.href=canvas.toDataURL();
link.click();
});
}

addRow();

</script>

</body>
</html>
